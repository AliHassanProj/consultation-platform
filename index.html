<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheduled Video Call</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #videos { display: flex; justify-content: center; }
        video { width: 300px; height: 225px; margin: 10px; background: #ddd; }
        #controls { margin: 20px 0; }
        #status { margin-top: 20px; text-align: left; padding: 10px; background: #f0f0f0; }
        #scheduler { margin-bottom: 20px; }
    </style>
</head>
<body>
    <h1>Scheduled Video Call</h1>
    <div id="scheduler">
        <h2>Schedule a Consultation</h2>
        <input type="date" id="dateInput">
        <input type="time" id="timeInput">
        <input type="email" id="clientEmail" placeholder="Client Email">
        <button onclick="scheduleConsultation()">Generate Link</button>
    </div>
    <div id="controls">
        <input type="text" id="roomInput" placeholder="Enter room code">
        <button onclick="joinRoom()">Join Room</button>
    </div>
    <div id="videos">
        <video id="localVideo" autoplay muted></video>
        <video id="remoteVideo" autoplay></video>
    </div>
    <div id="status"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <script>
        let peer;
        let conn;
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const statusDiv = document.getElementById('status');

        function updateStatus(message) {
            const now = new Date().toLocaleTimeString();
            statusDiv.innerHTML += `<p>[${now}] ${message}</p>`;
            console.log(`[${now}] ${message}`);
            statusDiv.scrollTop = statusDiv.scrollHeight;
        }

        function scheduleConsultation() {
            const date = document.getElementById('dateInput').value;
            const time = document.getElementById('timeInput').value;
            const clientEmail = document.getElementById('clientEmail').value;

            if (!date || !time || !clientEmail) {
                alert('Please fill in all fields');
                return;
            }

            const roomCode = generateRoomCode(date, time, clientEmail);
            const consultationLink = `${window.location.href}?room=${roomCode}`;

            updateStatus(`Consultation scheduled for ${date} at ${time}`);
            updateStatus(`Room Code: ${roomCode}`);
            updateStatus(`Consultation Link: ${consultationLink}`);

            // In a real application, you would send this link to the client's email
            alert(`Link generated: ${consultationLink}\n\nIn a real application, this would be sent to ${clientEmail}`);
        }

        function generateRoomCode(date, time, email) {
            const combined = `${date}-${time}-${email}`;
            return btoa(combined).replace(/[^a-zA-Z0-9]/g, '').slice(0, 20);
        }

        async function joinRoom() {
            let roomCode = document.getElementById('roomInput').value;
            
            // Check if room code is in URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const urlRoomCode = urlParams.get('room');
            if (urlRoomCode) {
                roomCode = urlRoomCode;
                document.getElementById('roomInput').value = roomCode;
            }

            if (!roomCode) {
                alert('Please enter a room code');
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                localVideo.srcObject = stream;
                updateStatus('Local stream acquired');

                peer = new Peer(null, {
                    debug: 2,
                    config: {'iceServers': [
                        { url: 'stun:stun.l.google.com:19302' },
                        { url: 'turn:numb.viagenie.ca', credential: 'muazkh', username: 'webrtc@live.com' }
                    ]}
                });

                peer.on('open', (id) => {
                    updateStatus(`Connected to PeerJS server with ID: ${id}`);
                    connectToPeer(roomCode, stream);
                });

                peer.on('call', (call) => {
                    updateStatus('Receiving call');
                    call.answer(stream);
                    call.on('stream', (remoteStream) => {
                        updateStatus('Received remote stream');
                        remoteVideo.srcObject = remoteStream;
                    });
                });

                peer.on('error', (error) => {
                    updateStatus(`PeerJS error: ${error}`);
                });

            } catch (err) {
                updateStatus(`Failed to get local stream: ${err.message}`);
                alert('Could not access camera and microphone. Please ensure they are connected and permissions are granted.');
            }
        }

        function connectToPeer(roomCode, stream) {
            updateStatus(`Attempting to join room: ${roomCode}`);
            conn = peer.connect(roomCode);

            conn.on('open', () => {
                updateStatus('Connected to peer in room');
                const call = peer.call(roomCode, stream);
                call.on('stream', (remoteStream) => {
                    updateStatus('Received remote stream');
                    remoteVideo.srcObject = remoteStream;
                });
            });

            conn.on('error', (error) => {
                updateStatus(`Connection error: ${error}`);
                peer.destroy();
                createRoom(roomCode, stream);
            });
        }

        function createRoom(roomCode, stream) {
            updateStatus(`Creating room: ${roomCode}`);
            peer = new Peer(roomCode, {
                debug: 2,
                config: {'iceServers': [
                    { url: 'stun:stun.l.google.com:19302' },
                    { url: 'turn:numb.viagenie.ca', credential: 'muazkh', username: 'webrtc@live.com' }
                ]}
            });

            peer.on('open', (id) => {
                updateStatus(`Room created with ID: ${id}`);
            });

            peer.on('connection', (dataConn) => {
                updateStatus('Peer joined the room');
                conn = dataConn;
            });

            peer.on('call', (call) => {
                updateStatus('Receiving call');
                call.answer(stream);
                call.on('stream', (remoteStream) => {
                    updateStatus('Received remote stream');
                    remoteVideo.srcObject = remoteStream;
                });
            });
        }

        // Check for room code in URL on page load
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const roomCode = urlParams.get('room');
            if (roomCode) {
                document.getElementById('roomInput').value = roomCode;
                joinRoom();
            }
        };
    </script>
</body>
</html>
